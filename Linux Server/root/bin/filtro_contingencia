#!/bin/bash
# Filtro de impresión para Lexmark Cloud Print Manager (MODO CONTINGENCIA)
# Preparado para BBVA por Javier Robles (Lexmark International)
# E-mail: antonio@robles.ai
# Usar set -x para activar modo debug (trace de comandos)
# set -x
# AVISO: VERSION COMPATIBLE SOLO CON LINUX SUSE 12 Y LEXMARK CLOUD PRINT MANAGER
# Fecha de actualización: v202509150000
rm=0

if [ -n "$6" ]
then
  file="$6"
else
  file=$(mktemp)
  cat > "$file"
  let rm++
fi

echo "================================CONTINGENCIA======v202509150000" >> /var/lib/lexmark/lexmark.log
date >> /var/lib/lexmark/lexmark.log
echo "1: $1" >> /var/lib/lexmark/lexmark.log
echo "2: $2" >> /var/lib/lexmark/lexmark.log
echo "3: $3" >> /var/lib/lexmark/lexmark.log
echo "4: $4" >> /var/lib/lexmark/lexmark.log
echo "5: $5" >> /var/lib/lexmark/lexmark.log
echo "6: $6" >> /var/lib/lexmark/lexmark.log

SPOOLID="$1"
SPOOLPATH="$6"
SPOOLNAME="$3"
HOSTID="$(hostname)"
SPOOLTYPE="$(/usr/bin/file "$file" | cut -d':' -f2)"

# Cola que ejecuta el filtro (primer match por job-id)
PUESTO="$(lpstat -W all -u | grep -m1 "\-$SPOOLID" | cut -d '-' -f1)"
USUARIO="$(finger 2>/dev/null | grep -m1 "$PUESTO" | cut -d ' ' -f1 | rev | cut -d '.' -f1 | rev)"
if [ -z "$USUARIO" ]; then
  USUARIO="$2"
fi
KEY="$(echo ${PUESTO:1:4})"

echo "Spool ID: $SPOOLID" >> /var/lib/lexmark/lexmark.log
echo "Spool Path: $SPOOLPATH" >> /var/lib/lexmark/lexmark.log
echo "Spool Name: $SPOOLNAME" >> /var/lib/lexmark/lexmark.log
echo "Spool Type:$SPOOLTYPE" >> /var/lib/lexmark/lexmark.log
echo "Puesto: $PUESTO" >> /var/lib/lexmark/lexmark.log
echo "Key: $KEY" >> /var/lib/lexmark/lexmark.log
echo "Usuario: $USUARIO"  >> /var/lib/lexmark/lexmark.log
echo "Host ID: $HOSTID" >> /var/lib/lexmark/lexmark.log

CURURI="${DEVICE_URI}"
if [ -z "$CURURI" ]; then
  CURURI="$(lpstat -v "$PUESTO" 2>/dev/null | awk -F': ' 'END{print $2}')"
fi
if [ -z "$CURURI" ]; then
  echo "ERROR: No se pudo determinar el DEVICE_URI/CURURI de la cola $PUESTO" >> /var/lib/lexmark/lexmark.log
  [ $rm -gt 0 ] && rm -f "$file"
  exit 1
fi
echo "CURURI (destino real cola): $CURURI" >> /var/lib/lexmark/lexmark.log

PRNIP="$(echo "$CURURI" | sed -E 's#^[a-zA-Z]+://([^/:]+).*#\1#')"
if [ -z "$PRNIP" ]; then
  echo "ERROR: No se pudo extraer IP de impresora física desde CURURI=$CURURI" >> /var/lib/lexmark/lexmark.log
  [ $rm -gt 0 ] && rm -f "$file"
  exit 1
fi
echo "IP impresora física: $PRNIP" >> /var/lib/lexmark/lexmark.log

LPD_BACKEND="/usr/lib/cups/backend/lpd"

DEVICE_URI="lpd://$PRNIP:515/lp"
echo "Enviando por LPR directo a $DEVICE_URI (spool ORIGINAL, sin modificar)..." >> /var/lib/lexmark/lexmark.log
"$LPD_BACKEND" "$SPOOLID" "$USUARIO" "$SPOOLNAME" "$4" "$5" "$file" >> /var/lib/lexmark/lexmark.log 2>&1
RET_BACKEND=$?
echo "Resultado de LPD backend: $RET_BACKEND" >> /var/lib/lexmark/lexmark.log

TEA4CUPS_QUEUE="p${PUESTO:1}"
EXISTE_TEA="$(lpstat -v 2>/dev/null | grep -c "$TEA4CUPS_QUEUE")"
echo "Existe Tea4Cups ($TEA4CUPS_QUEUE)?: $EXISTE_TEA" >> /var/lib/lexmark/lexmark.log
if [ "$EXISTE_TEA" -gt 0 ]; then
  echo "Enviando ORIGINAL a Tea4Cups: $TEA4CUPS_QUEUE con usuario $USUARIO" >> /var/lib/lexmark/lexmark.log
  lp -d "$TEA4CUPS_QUEUE" -U "$USUARIO" -t "$SPOOLNAME" "$file" > /dev/null 2>> /var/lib/lexmark/lexmark.log
  echo "Resultado de envío Tea4Cups: $?" >> /var/lib/lexmark/lexmark.log
else
  echo "No existe cola Tea4Cups $TEA4CUPS_QUEUE. Se omite." >> /var/lib/lexmark/lexmark.log
fi

[ $rm -gt 0 ] && rm -f "$file"
exit $RET_BACKEND